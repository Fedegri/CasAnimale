<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../css/style.css" />
    <script type="text/javascript" src="../script/index.js"></script>
    <title>CasAnimale - Back Office</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      let pts = [];
      let totPrenotations = 0;
      var user;

      $(document).ready(async () => {
        user = await isUserLogged();
        $("#sidebar").load("../tabs/sidebar.html");

        if (user.admin) getPts("");
        else getPts(user.id);
      });

      const getPts = async (id) => {
        var ret;
        id === ""
          ? (ret = await fetch("http://localhost:5000/api/prenotation", {
              method: "GET",
              credentials: "include",
            }))
          : (ret = await fetch(
              "http://localhost:5000/api/prenotation?company=" + id,
              {
                method: "GET",
                credentials: "include",
              }
            ));
        pts = await ret.json();
        loadList();
      };

      const deletePt = async (id) => {
        var ret = await fetch("http://localhost:5000/api/prenotation/" + id, {
          method: "DELETE",
          credentials: "include",
        });
        ret = await ret.json();
        alert(ret.message);
        window.location.reload();
      };

      const filterStartEndTime = (time, end) => {
        let hours = +time.substring(11, 13) + 1 + +end;
        time = hours > 12 ? (hours % 12) + "pm" : hours + "am";
        return time;
      };

      const formatTime = (time) => {
        let hours = +time.substring(11, 13) + 1;
        time = hours > 12 ? (hours % 12) + "pm" : hours + "am";
        time += " - ";
        time += hours + 1 > 12 ? ((hours + 1) % 12) + "pm" : hours + 1 + "am";
        return time;
      };

      const filterList = () => {
        let reqPrenotation = $("#filterPrenotationId").val();
        let reqCompany = $("#filterCompanyId").val();
        let reqCustomer = $("#filterUserId").val();
        let reqSchedule = $("#filterSchedule").val();
        let reqCity = $("#filterCity").val();
        let comparePrenotation = 0;
        let compareCompany = 0;
        let compareCustomer = 0;
        let compareSchedule = 0;
        let compareCity = 0;
        let tmp = "";
        $(document).ready(function () {
          if (pts !== undefined) {
            let index = 0;
            pts.map((item) => {
              comparePrenotation =
                reqPrenotation === ""
                  ? 0
                  : item._id.includes(reqPrenotation)
                  ? 0
                  : 1;
              compareCompany =
                reqCompany === ""
                  ? 0
                  : item.company.includes(reqCompany)
                  ? 0
                  : 1;
              compareCustomer =
                reqCustomer === ""
                  ? 0
                  : item.user.includes(reqCustomer)
                  ? 0
                  : 1;
              compareSchedule =
                reqSchedule === ""
                  ? 0
                  : filterStartEndTime(item.start, 0).includes(reqSchedule)
                  ? 0
                  : 1;
              compareCity =
                reqCity === ""
                  ? 0
                  : item.place.toLowerCase().includes(reqCity.toLowerCase())
                  ? 0
                  : 1;
              if (
                comparePrenotation +
                  compareCompany +
                  compareCustomer +
                  compareSchedule +
                  compareCity ===
                0
              ) {
                tmp += makeItemPrenotation(
                  index,
                  item._id,
                  item.place,
                  item.start,
                  item.user,
                  item.company
                );
                index++;
                totPrenotations = index;
              }
            });
          }
          tmp !== ""
            ? $("#ptsList").html(tmp)
            : $("#ptsList").html(
                `<p class="mt-4 font-semibold">No prenotations found with these filters</p>`
              );
          $("#totPrenotations").html("TOTAL RESULTS: " + totPrenotations);
          totPrenotations = 0;
        });
      };

      const makeItemPrenotation = (index, id, place, start, user, company) => {
        return (
          `
          <div class="flex flex-row my-3">
            <span class="mr-1">` +
          (index + 1) +
          `.
              </span>
            <div class="flex flex-row flex-1 bg-white/50 p-2 rounded">
              <div class="flex flex-col">
                <div><span class="font-semibold">Prenotation id: </span>
                  <button class="btn" onclick="copy(this)">` +
          id +
          `
            <i class="fa fa-copy"></i></button>
                </div>
                <div><span class="font-semibold">City: </span>` +
          place +
          `
                </div>
                <div><span class="font-semibold">Date: </span><span class=tohidden` +
          index +
          `>` +
          start.substring(0, 10) +
          `     </span><input
                type="text"
                name="newDate"
                id="newTimes` +
          index +
          `"
                value="` +
          start.substring(0, 10) +
          `"
                placeholder="Type new date"
                class="toshow` +
          index +
          ` hidden change px-1 rounded shadow-sm"
              />
            </div>
                <div class="tohidden` +
          index +
          `"><span class="font-semibold">Schedule: </span>` +
          formatTime(start) +
          `</div>
          <div class="toshow` +
          index +
          ` hidden"><span class="font-semibold">Start at: </span>
            <input
                type="text"
                name="newStart"
                id="newStart` +
          index +
          `"
                value="` +
          filterStartEndTime(start, 0) +
          `"
                placeholder="Type new start time"
                class="change px-1 rounded shadow-sm"
              />
          </div>
          <div class="toshow` +
          index +
          ` hidden"><span class="font-semibold">End at: </span>
            <input
                type="text"
                name="newEnd"
                id="newEnd` +
          index +
          `"
                value="` +
          filterStartEndTime(start, 1) +
          `"
                placeholder="Type new end time"
                class="change px-1 rounded shadow-sm"
              />
          </div>
                <div><span class="font-semibold">Company id: </span>
                  <button class="btn" onclick="copy(this)">` +
          company +
          `         <i class="fa fa-copy"></i></button>
                </div>
                <div><span class="font-semibold">Customer id: </span>
                  <button class="btn" onclick="copy(this)">` +
          user +
          `       <i class="fa fa-copy"></i></button>
                </div>
              </div>
              </div>
              <div class="flex flex-col self-center">
              <button class="tohidden` +
          index +
          ` btn bg-update p-1 m-2 hover:opacity-80 text-white font-bold rounded-xl self-center" onclick="{$('.tohidden` +
          index +
          `').addClass('hidden'); $('.toshow` +
          index +
          `').removeClass('hidden')}">
                Update
              </button>
              <button class="toshow` +
              index +
              ` hidden btn bg-save border-save border-2 p-1 px-4 m-2 hover:opacity-80 text-white font-bold rounded-lg self-center" onclick="{$('.tohidden` +
              index +
              `').removeClass('hidden'); $('.toshow` +
              index +
              `').addClass('hidden')}">
              SAVE
              </button>
              <button class="toshow` +
          index +
          ` hidden btn bg-transparent primary border-2 border-primary p-1 m-2 hover:opacity-80 font-bold rounded-lg self-center" onclick="{$('.tohidden` +
          index +
          `').removeClass('hidden'); $('.toshow` +
          index +
          `').addClass('hidden')}">
                CANCEL
              </button>
              <button class="tohidden` +
          index +
          ` btn bg-danger p-1 m-2 hover:opacity-80 text-white font-bold rounded-xl self-center" onclick="deletePt('` +
          id +
          `')">
                Delete
              </button>
            
            </div>
          </div>`
        );
      };
      const loadList = () => {
        let tmp = "";
        $(document).ready(function () {
          if (pts !== undefined) {
            pts.map((item, index) => {
              tmp += makeItemPrenotation(
                index,
                item._id,
                item.place,
                item.start,
                item.user,
                item.company
              );
              totPrenotations = index + 1;
            });
          }
          $("#ptsList").html(tmp);
          $("#totPrenotations").html("TOTAL RESULTS: " + totPrenotations);
          totPrenotations = 0;
        });
      };

      const copy = (that) => {
        var inp = document.createElement("input");
        document.body.appendChild(inp);
        inp.value = that.textContent.trim();
        inp.select();
        document.execCommand("copy", false);
        inp.remove();
      };

      const showFilters = () => {
        $("#prenotationsFilter").removeClass("hidden");
        $("#showBtn").addClass("hidden");
        $("#hideBtn").removeClass("hidden");
        $("#resetBtn").removeClass("hidden");
        if(user.admin)
          $(".adminOnly").removeClass("hidden");
      };

      const hideFilters = () => {
        $("#prenotationsFilter").addClass("hidden");
        $("#showBtn").removeClass("hidden");
        $("#hideBtn").addClass("hidden");
        $("#resetBtn").addClass("hidden");
      };

      const resetFilters = () => {
        $("#filterPrenotationId").val("");
        $("#filterCompanyId").val("");
        $("#filterUserId").val("");
        $("#filterSchedule").val("");
        $("#filterCity").val("");
        filterList();
      };

      // getPts();
      $(document).ready(function () {
        if(user.admin)
          $(".adminOnly").removeClass("hidden");
      })
    </script>
  </head>
  <body>
    <div class="flex flex-col md:flex-row flex-1 h-full">
      <div
        class="md:fixed flex justify-center py-5 md:py-0 md:pl-5 self-center"
        id="sidebar"
      ></div>
      <div class="flex flex-col w-full p-5 pt-0 ml-0 md:p-5 md:ml-[106px]">
        <div id="title" class="font-bold text-4xl sm:text-6xl m-4 self-center">
          PRENOTATIONS
        </div>
        <div class="flex flex-col mx-4 mb-1 flex-0">
          <div class="gray self-center">
            Click on something followed by
            <i class="fa fa-copy"></i> to copy it!
          </div>
          <div class="flex flex-row mt-2">
            <button
              id="showBtn"
              class="hidden flex btn bg-save p-1 hover:opacity-80 text-white font-bold rounded mr-2"
              onclick="showFilters()"
            >
              Show filters
            </button>
            <button
              id="hideBtn"
              class="flex btn bg-save p-1 hover:opacity-80 text-white font-bold rounded mr-2"
              onclick="hideFilters()"
            >
              Hide filters
            </button>
            <button
              id="resetBtn"
              class="flex btn bg-secondary p-1 hover:opacity-80 text-white font-bold rounded"
              onclick="resetFilters()"
            >
              Reset filters
            </button>
          </div>
        </div>
        <div id="list" class="flex flex-1 m-4 mt-2">
          <div class="flex flex-col flex-1">
            <div id="prenotationsFilter" class="flex flex-col">
              <!-- primo filtro-->
              <div class="flex flex-col sm:flex-row">
                <span class="flex">
                  <label
                    for="filterPrenotationId"
                    class="flex self-center primary font-semibold"
                    >Filter by prenotation id:</label
                  >
                </span>
                <span>
                  <input
                    id="filterPrenotationId"
                    name="filterPrenotationId"
                    type="text"
                    placeholder="ex. 63cecdc93b2ad296f8ed3989"
                    class="px-1 m-1 rounded w-[15rem]"
                    oninput="filterList()"
                  />
                </span>
              </div>
              <!-- secondo e terzo filtro-->
              <div class="flex flex-col lg:flex-row">
                <div class="flex flex-col sm:flex-row lg:mr-4 adminOnly hidden">
                  <span class="flex">
                    <label
                      for="filterCompanyId"
                      class="flex self-center primary font-semibold"
                      >Filter by company id:</label
                    >
                  </span>
                  <span>
                    <input
                      id="filterCompanyId"
                      name="filterCompanyId"
                      type="text"
                      placeholder="ex. 63c810b7a6a58c3116769cf9"
                      class="px-1 m-1 rounded w-[15rem]"
                      oninput="filterList()"
                    />
                  </span>
                </div>
                <div class="flex flex-col sm:flex-row lg:mr-4">
                  <span class="flex">
                    <label
                      for="filterUserId"
                      class="flex self-center primary font-semibold"
                      >Filter by customer id:</label
                    >
                  </span>
                  <span>
                    <input
                      id="filterUserId"
                      name="filterUserId"
                      type="text"
                      placeholder="ex. 635d00fdc77f11a1f22d313d"
                      class="px-1 m-1 rounded w-[15rem]"
                      oninput="filterList()"
                    />
                  </span>
                </div>
              </div>
              <!-- quarto e quinto filtro-->
              <div class="flex flex-col lg:flex-row">
                <div class="flex flex-col sm:flex-row lg:mr-4">
                  <span class="flex">
                    <label
                      for="filterSchedule"
                      class="flex self-center primary font-semibold"
                      >Filter by start time:</label
                    >
                  </span>
                  <span>
                    <input
                      id="filterSchedule"
                      name="filterSchedule"
                      type="text"
                      placeholder="ex. 9am"
                      class="px-1 m-1 rounded w-[15rem]"
                      oninput="filterList()"
                    />
                  </span>
                </div>

                <div class="flex flex-col sm:flex-row">
                  <span class="flex">
                    <label
                      for="filterCity"
                      class="flex self-center primary font-semibold"
                      >Filter by city:
                    </label>
                  </span>
                  <span>
                    <input
                      id="filterCity"
                      name="filterCity"
                      type="text"
                      placeholder="ex. Torino"
                      class="px-1 m-1 rounded w-[15rem]"
                      oninput="filterList()"
                    />
                  </span>
                </div>
              </div>
            </div>
            <div
              id="totPrenotations"
              class="flex flex-col flex primary font-semibold mt-4 my-2"
            ></div>
            <div id="ptsList" class="flex flex-col flex-1"></div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
