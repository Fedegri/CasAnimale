<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../css/style.css" />
    <script type="text/javascript" src="../script/index.js"></script>
    <title>CasAnimale - Back Office</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      let user;
      let data;
      let adminsList;
      let listLen =[{study_info : -1, professional_experience: -1, actual_jobs: -1, main_pets: -1}]
      $(document).ready(async () => {
        user = await isUserLogged();
        $("#sidebar").load("../tabs/sidebar.html");
        if (user.admin) {
          $("#title").html("PERSONAL PROFILE");
          getAdminInfo(user.id);
        } else {
          $("#companyInfo").removeClass("hidden");
          $("#title").html("COMPANY PROFILE");
          getAccountInfo(user.id);
        }
        $(".tab").addClass("ml-10");
      });
      const showTab = (divId) => {
        $(".tab").addClass("hidden");
        $(".btnInfo").removeClass("bg-primary");
        $("#" + divId).removeClass("hidden");
        $("#" + divId + "Btn").addClass("bg-primary");
      };
      const getAccountInfo = async (id) => {
        let ret = await fetch("http://localhost:5000/api/company?_id=" + id, {
          method: "GET",
          credentials: "include",
        });
        data = await ret.json();
        fillCompany();
      };
      const getAdminsList = async (id) => {
        let ret = await fetch("http://localhost:5000/api/admin", {
          method: "GET",
          credentials: "include",
        });
        adminsList = await ret.json();
        fillAdminsList();
      };
      const getAdminInfo = async (id) => {
        let ret = await fetch("http://localhost:5000/api/admin?_id=" + id, {
          method: "GET",
          credentials: "include",
        });
        data = await ret.json();
        fillAdmin();
        getAdminsList();
      };
      const fillAdminsList = () => {
        if (adminsList.length - 1 === 0)
          $("#otherAdmins").html(
            "<span class='mt-10 font-bold'>You are the only admin of CasAnimale.</span>"
          );
        let tmp =
          adminsList.length - 1 === 1
            ? `<div class='mt-10 font-bold'>There is 1 other admin.</div><div class="font-bold">Here their name and surname.</div>`
            : `<div class='mt-10 font-bold'><span>There are </span>` +
              (adminsList.length - 1) +
              ` <span> other admins.</span></div><div class="font-bold">Here their names and surnames.`;
        adminsList.map((item) => {
          if (item._id.localeCompare(data[0]._id) !== 0)
            tmp +=
              `<div class="primary font-bold my-8">` +
              item.name +
              ` ` +
              item.surname +
              `</div>
            `;
        });
        $("#otherAdmins").html(tmp);
      };
      const fillAdmin = () => {
        $(".adminOnly").removeClass("hidden");
        $("#newName").val(data[0].name);
        $("#newSurname").val(data[0].surname);
        $("#newPassword").val(data[0].password);
        $("#newEmail").val(data[0].email);
        $("#adminId").html(data[0]._id);
      };
      const fillCompany = () => {
        $("#newName").val(data[0].name);
        $("#newSurname").val(data[0].surname);
        $("#newOwner").val(data[0].owner);
        $("#newPassword").val(data[0].password);
        $("#newEmail").val(data[0].email);
        $("#adminId").html(data[0]._id);
        $("#careerInfo").prepend(listArray("professional_experience"));
        $("#careerInfo").prepend(listArray("study_info"));
        $("#careerInfo").prepend(listArray("main_pets"));
        $("#careerInfo").prepend(listArray("actual_jobs"));
        switch (data[0].type) {
          case "psy":
            $("#newProfession").html("psychologist");
            break;
          case "vet":
            $("#newProfession").html("veterinary");
            break;
          case "petsitter":
            $("#newProfession").html("petsitter");
            break;
            case "groomer":
              $("#newProfession").html("groomer");
              break;
          default:
              $("#newProfession").html("groomer");
        }
            $(".companyOnly").removeClass("hidden");
      };

      const getLenToUpdate = (type) => {
        switch(type){
              case 'actual_jobs':
                return (listLen[0].actual_jobs)
                break;
              case 'main_pets':
                return (listLen[0].main_pets)
                break;
              case 'study_info':
                return (listLen[0].study_info)
                break;
              case 'professional_experience':
                return (listLen[0].professional_experience)
                break;
              default:
            }
      }
      const listArray = (type) => {
        let array;
        let title;
        let count = 0;
        let lenToUpdate;
        switch(type){
          case 'actual_jobs':
            array = data[0].actual_jobs;
            title = data[0].name + "'s actual jobs:";
            break;
          case 'main_pets':
            array = data[0].main_pets;
            title = data[0].name + "'s main pets of interest:";
            break;
          case 'study_info':
            array = data[0].study_info;
            title = data[0].name + "'s study info:";
            break;
          case 'professional_experience':
            array = data[0].professional_experience;
            title = data[0].name + "'s professional experience:";
            break;
          default:
            array = undefined;
        }
        console.log(array);
        let tmp = `<div id="` + type + `"><div class="primary font-semibold mt-10">`+ title + `</div>`;
        if ( array !== undefined) {
          array.map((item, index) => {
            tmp +=
              `<div>
              <input
                type="text"
                name="new` +
              type +
              index +
              `"
                id="new` +
              type +
              index +
              `"
                value="` +
              item +
              `"
                placeholder="Type new field"
                class="change px-1 rounded shadow-sm border-primary my-2 ml-16 bg-transparent"
              />
            </div>`;
            count = index;
            switch(type){
              case 'actual_jobs':
                lenToUpdate = ++listLen[0].actual_jobs
                break;
              case 'main_pets':
                lenToUpdate = ++listLen[0].main_pets
                break;
              case 'study_info':
                lenToUpdate = ++listLen[0].study_info
                break;
              case 'professional_experience':
                lenToUpdate = ++listLen[0].professional_experience
                break;
              default:
            }
          });
        }
          console.log("len: " + lenToUpdate)
          tmp += `</div>
            <div id="add` + type + `"></div>
              <button class="btn my-2 ml-16 px-1 rounded font-bold bg-primary text-white mt-1" onclick="addField('` + type +`', (getLenToUpdate('` + type + `')+1))">+</button>`
          console.log(tmp)
        return tmp;
      };

      const addField = (type, count) => {
        switch(type){
              case 'actual_jobs':
                listLen[0].actual_jobs++
                break;
              case 'main_pets':
                listLen[0].main_pets++
                break;
              case 'study_info':
                listLen[0].study_info++
                break;
              case 'professional_experience':
                listLen[0].professional_experience++
                break;
              default:
            }
        $("#add" + type).append(
        //console.log(  
        `<div>
            <input
              type="text"
              name="new` +
            type +
            count +
            `"
              id="new` +
            type +
            count +
            `"
              placeholder="Type new field"
              class="change px-1 rounded shadow-sm border-primary my-2 ml-16 bg-transparent"
            />
          </div>`
        )
      }

    </script>
  </head>
  <body>
    <div class="flex flex-col md:flex-row flex-1 h-full">
      <div
        class="md:fixed flex justify-center py-5 md:py-0 md:pl-5 self-center"
        id="sidebar"
      ></div>
      <div class="flex flex-col w-full p-5 pb-0 pt-0 ml-0 md:ml-[106px]">
        <div
          id="title"
          class="flex font-bold text-4xl sm:text-6xl m-4 self-center"
        ></div>
        <div id="info" class="flex flex-1 mt-4">
          <div
            id="bar"
            class="flex h-full flex-col w-80 bg-secondary"
            style="flex: 0 0 auto"
          >
            <button
              id="publicInfoBtn"
              class="btnInfo border-b-light thirdColor font-bold text-xl py-3 hover:opacity-50 bg-primary"
              onclick="showTab('publicInfo')"
            >
              Public information
            </button>
            <button
              id="privateInfoBtn"
              class="btnInfo border-b-light thirdColor font-bold text-xl py-3 hover:opacity-50"
              onclick="showTab('privateInfo')"
            >
              Privacy and security
            </button>
            <button
              id="placesBtn"
              class="hidden companyOnly btnInfo border-b-light thirdColor font-bold text-xl py-3 hover:opacity-50"
              onclick="showTab('places')"
            >
              Working places
            </button>
            <button
              id="servicesInfoBtn"
              class="hidden companyOnly btnInfo border-b-light thirdColor font-bold text-xl py-3 hover:opacity-50"
              onclick="showTab('servicesInfo')"
            >
              Services
          </button>
          <button
              id="careerInfoBtn"
              class="hidden companyOnly btnInfo border-b-light thirdColor font-bold text-xl py-3 hover:opacity-50"
              onclick="showTab('careerInfo')"
            >
              Career
            <button>

            </button>
            <button
              id="newAdminBtn"
              class="hidden adminOnly btnInfo border-b-light thirdColor font-bold text-xl py-3 hover:opacity-50"
              onclick="showTab('newAdmin')"
            >
              Create new admin
            </button>
            <button
              id="otherAdminsBtn"
              class="hidden adminOnly btnInfo border-b-light thirdColor font-bold text-xl py-3 hover:opacity-50"
              onclick="showTab('otherAdmins')"
            >
              Other admins
            </button>
          </div>
          <div
            class="flex flex-1 text-xl ml-4 border-t-solid border-t-[1px] border-t-[#59114d]"
          >
            <div id="publicInfo" class="tab">
              <div class="my-8">
                <span class="adminOnly hidden primary font-semibold"
                  >Name:</span
                >
                <span class="companyOnly hidden primary font-semibold"
                  >Company name:</span
                >
                <input
                  id="newName"
                  name="newNameAdmin"
                  placeholder="Type new name"
                  class="change px-1 rounded shadow-sm border-primary ml-3 bg-transparent"
                />
              </div>
              <div class="adminOnly hidden my-8">
                <span class="primary font-semibold">Surname:</span>
                <input
                  id="newSurname"
                  name="newSurname"
                  placeholder="Type new surname"
                  class="change px-1 rounded shadow-sm border-primary ml-3 bg-transparent"
                />
              </div>
              <div class="companyOnly hidden my-8">
                <span class="primary font-semibold">Company owner:</span>
                <input
                  id="newOwner"
                  name="newOwner"
                  placeholder="Type new owner"
                  class="change px-1 rounded shadow-sm border-primary ml-3 bg-transparent"
                />
              </div>
              <div class="companyOnly hidden mt-8">
                <span class="primary font-semibold">Profession:</span>
                <span
                  id="newProfession"
                  class="change px-1 ml-3 bg-transparent"
                ></span>
              </div>
              <button
              class="flex bg-save px-2 py-2 my-10 rounded self-center font-bold thirdColor hover:opacity-75"
            >
              UPDATE
            </button>
            </div>
            <div id="privateInfo" class="tab hidden">
              <div class="my-8">
                <span class="primary font-semibold">Email:</span>
                <input
                  id="newEmail"
                  name="newEmail"
                  placeholder="Type new email"
                  class="change px-1 rounded shadow-sm border-primary ml-3 bg-transparent"
                />
              </div>
              <div class="my-8">
                <span class="primary font-semibold">Password:</span>
                <input
                  id="newPassword"
                  name="newPassword"
                  placeholder="Type new password"
                  class="change px-1 rounded shadow-sm border-primary ml-3 bg-transparent"
                />
              </div>
              <div class="mt-8">
                <span class="primary font-semibold">Id:</span>
                <span id="adminId" class="ml-3"></span>
              </div>
              <button
              class="flex bg-save px-2 py-2 my-10 rounded self-center font-bold thirdColor hover:opacity-75"
            >
              UPDATE
            </button>
            </div>
            <div id="newAdmin" class="tab hidden">
              <div class="adminOnly hidden my-8">
                <div class="primary font-semibold">
                  These credentials will create a new admin account.
                </div>
                <div class="primary font-semibold mb-16">
                  They will be able to access back office and modify every data
                  and information about customers, companies and prenotations.
                </div>
                <div class="flex flex-col" id="createNewAdminTab">
                  <div class="primary my-8">
                    <span class="font-semibold">New admin name:</span>
                    <input
                      id="createAdminName"
                      name="createAdminName"
                      placeholder="Type new admin name"
                      class="change px-1 rounded shadow-sm border-primary ml-3 bg-transparent"
                    />
                  </div>
                  <div class="primary my-8">
                    <span class="font-semibold">New admin surname:</span>
                    <input
                      id="createAdminSurname"
                      name="createAdminSurname"
                      placeholder="Type new admin surname"
                      class="change px-1 rounded shadow-sm border-primary ml-3 bg-transparent"
                    />
                  </div>
                  <div class="primary my-8">
                    <span class="font-semibold">New admin email:</span>
                    <input
                      id="createAdminEmail"
                      name="createAdminEmail"
                      placeholder="Type new admin email"
                      class="change px-1 rounded shadow-sm border-primary ml-3 bg-transparent"
                    />
                  </div>
                  <div class="primary my-8">
                    <span class="font-semibold">New admin password:</span>
                    <input
                      id="createAdminPassword"
                      name="createAdminPassword"
                      placeholder="Type new admin password"
                      class="change px-1 rounded shadow-sm border-primary ml-3 bg-transparent"
                    />
                  </div>
                  <button
                    class="flex bg-save px-4 py-3 my-20 rounded self-center font-bold thirdColor hover:opacity-75"
                  >
                    CREATE NEW ADMIN
                  </button>
                </div>
                <span
                  id="newProfession"
                  class="change px-1 ml-3 bg-transparent"
                ></span>
              </div>
            </div>
            <div id="careerInfo" class="tab hidden mb-4">
              <button
              class="flex bg-save px-2 py-2 my-10 rounded self-center font-bold thirdColor hover:opacity-75"
            >
              UPDATE
            </button>
            </div>
            <div id="otherAdmins" class="tab hidden"></div>
            <div id="places" class="tab hidden">
              <button
              class="flex bg-save px-2 py-2 my-10 rounded self-center font-bold thirdColor hover:opacity-75"
            >
              UPDATE
            </button>
            </div>
            <div id="servicesInfo" class="tab hidden">
              services info
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
