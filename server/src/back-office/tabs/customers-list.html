<head>
  <script>
    let cstmrs = [];
    let totCustomers = 0;
    const getCusts = async () => {
      var ret = await fetch("http://localhost:5000/api/user", {
        method: "GET",
        //body: {},
        credentials: "include",
      });
      cstmrs = await ret.json();
      await loadList();
    };
    //TODO non funziona
    const deleteCust = async (id) => {
      var ret = await fetch("http://localhost:5000/api/user/" + id, {
        method: "DELETE",
        body: {},
        credentials: "include",
      });
      window.location.reload();
    };
    const filterStartTime = (time) => {
      let hours = +time.substring(11, 13) + 1;
      time = hours > 12 ? (hours % 12) + "pm" : hours + "am";
      return time;
    };

    const filterList = () => {
      let reqId = $("#filterCustomerId").val();
      let reqEmail = $("#filterCustomerEmail").val();
      let reqBirthDate = $("#filterCustomerBirthDate").val();
      let reqVIP = $("#filterOnlyVIP").val();
      let reqNotVIP = $("#filterNotVIP").val();
      let comparePrenotation = 0;
      let compareCompany = 0;
      let compareCustomer = 0;
      let compareSchedule = 0;
      let compareCity = 0;
      let tmp = "";
      $(document).ready(function () {
        if (cstmrs !== undefined) {
          let index = 0;
          cstmrs.map((item) => {
            comparePrenotation = reqPrenotation === "" ? 0 : reqPrenotation === item._id ? 0 : 1;
            compareCompany = reqCompany === "" ? 0 : reqCompany === item.company ? 0 : 1;
            compareCustomer = reqCustomer === "" ? 0 : reqCustomer === item.user ? 0 : 1;
            compareSchedule = reqSchedule === "" ? 0 : reqSchedule === filterStartTime(item.start) ? 0 : 1;
            compareCity = reqCity === "" ? 0 : reqCity.toLowerCase() === item.place.toLowerCase() ? 0 : 1;
            if (
              comparePrenotation + compareCompany + compareCustomer + compareSchedule + compareCity === 0
            ) {
              tmp += makeItemPrenotation(
                index,
                item._id,
                item.place,
                item.start,
                item.user,
                item.company
              );
              index++;
              totPrenotations = index;
            }
          });
        }
        tmp !== ""
          ? $("#ptsList").html(tmp)
          : $("#ptsList").html("No prenotations founded with these filters");
        $("#totPrenotations").html("TOTAL RESULTS: " + totPrenotations);
        totPrenotations = 0;
      });
    };

    const formatTime = (time) => {
      let hours = +time.substring(11, 13) + 1;
      time = hours > 12 ? (hours % 12) + "pm" : hours + "am";
      time += " - ";
      time += hours + 1 > 12 ? ((hours + 1) % 12) + "pm" : hours + 1 + "am";
      return time;
    };

    const makeItemPrenotation = (index, id, place, start, user, company) => {
      return (
        `
        <div class="flex flex-row my-3">
          <span class="mr-1">`
            + (index + 1) + `.
          </span>
          <div class="flex flex-row flex-1 bg-white/50 p-2 rounded">
            <div class="flex flex-col">
              <div><span class="font-semibold">Prenotation id: </span>
                <button class="btn" onclick="copy(this)">`
                  + id + `
                  <i class="fa fa-copy"></i>
                </button>
              </div>
              <div><span class="font-semibold">City: </span>`
                + place + `
              </div>
              <div><span class="font-semibold">Date: </span>`
                + start.substring(0, 10) + `
              </div>
              <div><span class="font-semibold">Schedule: </span>`
                + formatTime(start) + `
              </div>
              <div><span class="font-semibold">Company id: </span>
                <button class="btn" onclick="copy(this)">`
                  + company + `
                  <i class="fa fa-copy"></i>
                </button>
              </div>
              <div><span class="font-semibold">Customer id: </span>
                <button class="btn" onclick="copy(this)">`
                  + user + `
                  <i class="fa fa-copy"></i>
                </button>
              </div>
            </div>
            <button class="btn bg-danger p-1 mx-2 hover:opacity-80 text-white font-bold rounded-xl self-center" onclick="deletePt('`
              + company + `')">
              Delete
            </button>
          </div>
        </div>`
      );
    };
    const loadList = () => {
      let tmp = "";
      $(document).ready(function () {
        if (cstmrs !== undefined) {
          cstmrs.map((item, index) => {
            tmp += makeItemPrenotation(
              index,
              item._id,
              item.place,
              item.start,
              item.user,
              item.company
            );
            totPrenotations = index + 1;
          });
        }
        $("#ptsList").html(tmp);
        $("#totPrenotations").html("TOTAL RESULTS: " + totPrenotations);
        totPrenotations = 0;
      });
    };

    const copy = (that) => {
      var inp = document.createElement("input");
      document.body.appendChild(inp);
      inp.value = that.textContent.trim();
      inp.select();
      document.execCommand("copy", false);
      inp.remove();
    };
    getPts();
  </script>
</head>

<body>
  <div class="flex flex-col flex-1">
    <div id="prenotationsFilters" class="flex flex-col">
      <!-- primo filtro-->
      <div class="flex flex-col sm:flex-row">
        <span class="flex">
          <label for="filterCustomerId" class="flex self-center primary font-semibold">Filter by customer id:</label>
        </span>
        <span>
          <input id="filterCustomerId" name="filterCustomerId" type="text"
            placeholder="ex. 63cecdc93b2ad296f8ed3989" class="px-1 m-1 rounded w-[15rem]" oninput="filterList()" />
        </span>
      </div>
      <!-- secondo e terzo filtro-->
      <div class="flex flex-col lg:flex-row">
        <div class="flex flex-col sm:flex-row lg:mr-4">
          <span class="flex">
            <label for="filterCustomerEmail" class="flex self-center primary font-semibold">Filter by email:</label>
          </span>
          <span>
            <input id="filterCustomerEmail" name="filterCustomerEmail" type="email" placeholder="ex. rossi@gmail.com"
              class="px-1 m-1 rounded w-[15rem]" oninput="filterList()" />
          </span>
        </div>
        <div class="flex flex-col sm:flex-row lg:mr-4">
          <span class="flex">
            <label for="filterCustomerBirthDate" class="flex self-center primary font-semibold">Filter by birth date:</label>
          </span>
          <span>
            <input id="filterCustomerBirthDate" name="filterCustomerBirthDate" type="text" placeholder="ex. 12-12-2022"
              class="px-1 m-1 rounded w-[15rem]" oninput="filterList()" />
          </span>
        </div>
      </div>
      <!-- quarto e quinto filtro-->
      <div class="flex flex-col lg:flex-row">
        <div class="flex flex-col sm:flex-row lg:mr-4">
          <span class="flex">
            <label for="filterOnlyVIP" class="flex self-center primary font-semibold">VIP customers </label>
          </span>
          <span>
            <input id="filterOnlyVIP" name="filterOnlyVIP" type="radio" value="VIP" class="px-1 m-1 rounded w-[15rem]" oninput="filterList()" />
          </span>
        </div>

        <div class="flex flex-col sm:flex-row lg:mr-4">
          <span class="flex">
            <label for="filterNotVIP" class="flex self-center primary font-semibold">Non VIP customers </label>
            <input id="filterNotVIP" name="filterNotVIP" type="radio" value="VIP" class="px-1 m-1" oninput="filterList()" />
          </span>
          <!--<span class="flex justify-start">
            <input id="filterNotVIP" name="filterNotVIP" type="radio" value="VIP" class="px-1 m-1 justify-self-start w-[15rem]" oninput="filterList()" />
          </span>-->
        </div>
      </div>
    </div>
    <div id="totPrenotations" class="flex flex-col flex primary font-semibold mt-4 my-2"></div>
    <div id="ptsList" class="flex flex-col flex-1"></div>
  </div>
</body>