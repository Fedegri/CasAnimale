<head>
  <script>
    let cstmrs = [];
    let totCustomers = 0;
    const getCusts = async () => {
      var ret = await fetch("http://localhost:5000/api/user", {
        method: "GET",
        //body: {},
        credentials: "include",
      });
      cstmrs = await ret.json();
      await loadList();
    };
    //TODO non funziona
    const deleteCstmr = async (id) => {
      var ret = await fetch("http://localhost:5000/api/user/" + id, {
        method: "DELETE",
        body: {},
        credentials: "include",
      });
      window.location.reload();
    };
    const filterStartTime = (time) => {
      let hours = +time.substring(11, 13) + 1;
      time = hours > 12 ? (hours % 12) + "pm" : hours + "am";
      return time;
    };
    var toUTC = function (date) {
      var newDate = new Date();
      newDate.setTime(date.getTime() + (date.getTimezoneOffset() * 60 * 1000));
      return newDate;
    };
    const filterList = () => {
      let reqId = $("#filterCustomerId").val();
      let reqEmail = $("#filterCustomerEmail").val();
      let reqBirthDate = $("#filterCustomerBirthDate").val();
      let reqMinBirthDate = $("#filterMinDate").val();
      let reqMaxBirthDate = $("#filterMaxDate").val();
      let reqFavAnimal = $("#filterFavAnimal").val();
      let reqVIP = $("#filterVIP").val();
      let compareId = 0;
      let compareEmail = 0;
      let compareBirthDate = 0;
      let compareMinBirthDate = 0;
      let compareMaxBirthDate = 0;
      let compareFavAnimal = 0;
      let compareVIP = 0;
      let tmp = "";
      $(document).ready(function () {
        if (cstmrs !== undefined) {
          let index = 0;
          cstmrs.map((item) => {
            compareId = reqId === "" ? 0 : item._id.toLowerCase().includes(reqId.toLowerCase()) ? 0 : 1;
            compareEmail = reqEmail === "" ? 0 : item.email.toLowerCase().includes(reqEmail.toLowerCase()) ? 0 : 1;
            compareBirthDate = reqBirthDate === "" ? 0 : reqBirthDate === item.birth.substring(0, 10) ? 0 : 1;
            compareMinBirthDate = reqMinBirthDate === "" ? 0 : new Date(reqMinBirthDate).getTime() <= new Date(item.birth).getTime() ? 0 : 1;
            compareMaxBirthDate = reqMaxBirthDate === "" ? 0 : new Date(reqMaxBirthDate).getTime() >= new Date(item.birth).getTime() ? 0 : 1;
            compareFavAnimal = reqFavAnimal === "" ? 0 : item.favanimal.toLowerCase().includes(reqFavAnimal.toLowerCase()) ? 0 : 1;
            compareVIP = reqVIP === "" ? 0 : reqVIP === 'true' ? (item.vip === true ? 0 : 1) : (item.vip === false || item.vip === undefined ? 0 : 1);
            if (
              compareId + compareEmail + compareBirthDate + compareMinBirthDate + compareMaxBirthDate + compareFavAnimal + compareVIP === 0
            ) {
              tmp += makeItemCustomer(
                index,
                item._id,
                item.name,
                item.surname,
                item.birth,
                item.email,
                item.password,
                item.favanimal,
                item.cart,
                item.vip
              );
              index++;
              totCustomers = index;
            }
          });
        }
        tmp !== ""
          ? $("#cstmrsList").html(tmp)
          : $("#cstmrsList").html("No prenotations founded with these filters");
        $("#totCustomers").html("TOTAL RESULTS: " + totCustomers);
        totCustomers = 0;
      });
    };

    const makeItemCustomer = (index, id, name, surname, birth, email, password, favanimal, cart, vip) => {
      return (
        `
        <div class="flex flex-row my-3">
          <span class="mr-1">`
            + (index + 1) + `.
          </span>
          <div class="flex flex-row flex-1 bg-white/50 p-2 rounded">
            <div class="flex flex-col">
              <div><span class="font-semibold">Customer id: </span>
                <button class="btn" onclick="copy(this)">`
                  + id + `
                  <i class="fa fa-copy"></i>
                </button>
                <span class="font-semibold">`
                  + isVIP(vip) + `
                </span>
              </div>
              <div><span class="font-semibold">Name: </span>`
                + name + `
              </div>
              <div><span class="font-semibold">Surname: </span>`
                + surname + `
              </div>
              <div><span class="font-semibold">Birth date: </span>`
                + birth.substring(0, 10) + `
              </div>
              <div><span class="font-semibold">Email: </span>
                <button class="btn" onclick="copy(this)">`
                  + email + `
                  <i class="fa fa-copy"></i>
                </button>
              </div>
              <div><span class="font-semibold">Password: </span>`
                + password + `
              </div>
              <div><span class="font-semibold">Favorite animal: </span>`
                + favanimal + `
              </div>
              <div><span class="font-semibold">Cart: </span>`
                + showCart(cart) + `
              </div>
            </div>
            <button class="btn bg-danger p-1 mx-2 hover:opacity-80 text-white font-bold rounded-xl self-center" onclick="deleteCstmr('`
              + id + `')">
              Delete
            </button>
          </div>
        </div>`
      );
    };
    const loadList = () => {
      let tmp = "";
      $(document).ready(function () {
        console.log("debugging");
        if (cstmrs !== undefined) {
          cstmrs.map((item, index) => {
            tmp += makeItemCustomer(
              index,
              item._id,
              item.name,
              item.surname,
              item.birth,
              item.email,
              item.password,
              item.favanimal,
              item.cart,
              item.vip
            );
            totCustomers = index + 1;
          });
        }
        $("#cstmrsList").html(tmp);
        $("#totCustomers").html("TOTAL RESULTS: " + totCustomers);
        totCustomers = 0;
      });
    };

    const copy = (that) => {
      var inp = document.createElement("input");
      document.body.appendChild(inp);
      inp.value = that.textContent.trim();
      inp.select();
      document.execCommand("copy", false);
      inp.remove();
    };

    const isVIP = (vip) => {
      if(vip === true)
        return "VIP";
      else
        return "";
    };
    const showCart = (array) => {
      let ret = "";
      if(array.length > 0){
        array.map((item) => {
          ret += item.id + ", ";
        })
        return ret.substring(0, ret.length - 2);   // tolgo gli utili due caratteri ", "
      }
      else
        return "-";
    };
    getCusts();
  </script>
</head>

<body>
  <div class="flex flex-col flex-1">
    <div id="customersFilters" class="flex flex-col">
      <!-- primo filtro-->
      <div class="flex flex-col sm:flex-row">
        <span class="flex">
          <label for="filterCustomerId" class="flex self-center primary font-semibold">Filter by customer id:</label>
        </span>
        <span>
          <input id="filterCustomerId" name="filterCustomerId" type="text"
            placeholder="ex. 63cecdc93b2ad296f8ed3989" class="px-1 m-1 rounded w-[15rem]" oninput="filterList()" />
        </span>
      </div>
      <!-- secondo e terzo filtro-->
      <div class="flex flex-col lg:flex-row">
        <div class="flex flex-col sm:flex-row lg:mr-4">
          <span class="flex">
            <label for="filterCustomerEmail" class="flex self-center primary font-semibold">Filter by email:</label>
          </span>
          <span>
            <input id="filterCustomerEmail" name="filterCustomerEmail" type="email" placeholder="ex. rossi@gmail.com"
              class="px-1 m-1 rounded w-[15rem]" oninput="filterList()" />
          </span>
        </div>
        <div class="flex flex-col sm:flex-row lg:mr-4">
          <span class="flex">
            <label for="filterCustomerBirthDate" class="flex self-center primary font-semibold">Filter by birth date: </label>
          </span>
          <span>
            <input id="filterCustomerBirthDate" name="filterCustomerBirthDate" type="text" placeholder="ex. yyyy-mm-dd"
              class="px-1 m-1 rounded w-[15rem]" oninput="filterList()" />
          </span>
        </div>
      </div>
      <!-- quarto e quinto filtro-->
      <div class="flex flex-col lg:flex-row">
        <div class="flex flex-col sm:flex-row lg:mr-4">
          <span class="flex">
            <label for="filterMinDate" class="flex self-center primary font-semibold">Filter by min birth date: </label>
          </span>
          <span>
            <input id="filterMinDate" name="filterMinDate" type="text" placeholder="ex. yyyy-mm-dd"
              class="px-1 m-1 rounded w-[12rem]" oninput="filterList()" />
          </span>
        </div>
      
        <div class="flex flex-col sm:flex-row lg:mr-4">
          <span class="flex">
            <label for="filterMaxDate" class="flex self-center primary font-semibold">Filter by max birth date: </label>
          </span>
          <span>
            <input id="filterMaxDate" name="filterMaxDate" type="text" placeholder="ex. yyyy-mm-dd"
              class="px-1 m-1 rounded w-[12rem]" oninput="filterList()" />
          </span>
        </div>
      </div>
      <!-- sesto e settimo filtro-->
      <div class="flex flex-col lg:flex-row">
        <div class="flex flex-col sm:flex-row lg:mr-4">
          <span class="flex">
            <label for="filterFavAnimal" class="flex self-center primary font-semibold">Filter by favorite animal: </label>
          </span>
          <span>
            <input id="filterFavAnimal" name="filterFavAnimal" type="text" placeholder="ex. dog" class="px-1 m-1 rounded w-[12rem]" oninput="filterList()" />
          </span>
        </div>

        <div class="flex flex-col sm:flex-row lg:mr-4">
          <span class="flex">
            <label for="filterVIP" class="flex self-center primary font-semibold">VIP option: </label>
          </span>
          <span class="flex justify-start">
            <select id="filterVIP" name="filterVIP" type="text" placeholder="ex. psychologist"
              class="px-1 m-1 rounded w-[15rem] bg-[#FFFFFF]" oninput="filterList()">
              <option value="" class="text-[#939798]">
                --Chose an option--
              </option>
              <option value="true">VIP</option>
              <option value="false">Not VIP</option>
            </select>
          </span>
        </div>
      </div>
    </div>
    <div id="totCustomers" class="flex flex-col flex primary font-semibold mt-4 my-2"></div>
    <div id="cstmrsList" class="flex flex-col flex-1"></div>
  </div>
</body>